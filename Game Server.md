# Привязка матчей к игровому серверу

1. **Игровой сервер запрашивает у API список доступных матчей**

   Для этого используется запрос на список серверов с параметром `status=0` , который отфильтрует матчи и выдаст только те, что в API не имеют привязанного сервера

   **GET** http://cyberapi.l-b.uz/socket/server/list/?status=0&limit=2

   

   Ответ

   ```json
   {
       "count": 6,
       "next": "http://127.0.0.1:8000/socket/server/list/?limit=2&offset=2&status=0",
       "previous": null,
       "results": {
           "servers": [
               {
                   "id": 10,
                   "host_address": null,
                   "port": 8080,
                   "init_user": 59,
                   "game_type": 0,
                   "status": 0,
                   "server_type": 1,
                   "date_created": "2020-10-01T21:58:14.468146+05:00"
               },
               {
                   "id": 9,
                   "host_address": null,
                   "port": 8080,
                   "init_user": 59,
                   "game_type": 0,
                   "status": 0,
                   "server_type": 1,
                   "date_created": "2020-10-01T21:56:54.983418+05:00"
               }
           ]
       }
   }
   ```

2. **Игровой сервер выбирает матч, который будет хостить**

   Игровой сервер из предыдущего списка выбирает игру и отправляет запрос с её `id`

   **PUT** http://cyberapi.l-b.uz/socket/server/assign/{id}/

   в теле запроса должен содержаться json

   ```json
   {
       "login": "default_server",
       "password": "an8SK9eUfFiHijy",
       "ip": "127.0.0.1",
       "port": "8080"
   }
   ```

   Для авторизации все сервера используют общий "логин + пароль" учётки дефолтного сервера, а после выбора сервера, API привяжет отправленные `ip` и `port` к выбранному матчу

   Ответ

   ```json
   {
       "id": 11,
       "host_address": "127.0.0.1",
       "port": 8080,
       "status": 1,
       "date_created": "2020-10-01T21:58:33.752827+05:00",
       "token": "10c5e710495ffdfa35f0f2eb0015553008dc29e3",
       "game_type": 0,
       "server_type": 1,
       "init_user": 59,
       "white_list": []
   }
   ```

3. **Игровой сервер объявляет начало игры**

   После того как сервер получил матч и набрал нужное количество игроков, сервер предупреждает API, что он стартует матч, путём изменения статуса матча на "Game in process"

   **PUT** http://cyberapi.l-b.uz/socket/server/update/ 

   В теле запроса должен содержаться токен сервера, полученный из прошлого ответа и статус с кодом на "Game in process"

   ```json
   {
       "token": "10c5e710495ffdfa35f0f2eb0015553008dc29e3",
       "status": 2
   }
   ```

   Ответ

   ```
   {
       "detail": "Successfully changed state"
   }
   ```

4. **Игровой сервер объявляет конец игры**

   После того как сервер закончил матч и набрал нужное количество статистики, сервер предупреждает API, что он заканчивает матч, путём изменения статуса матча на "Game finished" и передаёт нужную статистику

   **PUT** http://cyberapi.l-b.uz/socket/server/update/

   В теле запроса должен содержаться токен сервера, полученный из 2го ответа и статус с кодом на "Game finished"

   ```json
   {
       "token": "10c5e710495ffdfa35f0f2eb0015553008dc29e3",
       "status": 3
   }
   ```

   Ответ

   ```json
   {
       "detail": "Successfully changed state"
   }
   ```

   

## Статусы серверов 

| Код для запросов | Обозначение в админе | Статус                                                |
| ---------------- | -------------------- | ----------------------------------------------------- |
| `0`              | Server not assigned  | Нету игрового сервера                                 |
| `1`              | Waiting for players  | Игровой сервер приписан, ждёт игроков к присоединению |
| `2`              | Game in process      | Игра началась, игроки больше не могут присоединяться  |
| `3`              | Game finished        | Игра окончена, сервер передаёт API статистику         |
| `4`              | Ready for close      | API принял статистику, сервер может закрваться        |

## White List

Список игроков может быть пустым, например если сервер публичный и к нему может присоединиться кто угодно. Но в общем игроки, которым разрешено играть на данном сервере будут попадать по приглашениям, т.е. в стандартной рутине отправке приглашение автоматически игроки получившие приглашения будут попадать в `white list`. Если приглашение было отправлено после "привязки игрового сервера", то игровой сервер получит уведомление о новом игроке в `white list` через сокет

Уведомление о новом игроке

```json
{
    "action":"white_list_update",
    "added":49 // id игрока добавленног в white list
}
```

Для того, чтобы игровой сервер мог получать уведомления от сокета, его необходимо присоединить стандартным запросом `connect`, указав `ip` сервера как его `uuid`

```json
{
	"action": "connect",
	"uuid": "127.0.0.1"
}
```

